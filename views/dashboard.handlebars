{{> navbar user}}



<div class="container is-fluid">
    <div class="columns">
        <div class="column">
            <div class="title" style="text-align: center;">Dashboard!</div>
            <h4 class="display-6 is-size-4 email-user">Hello, {{user.email}}!</h4>
            <br>
            <div class="box ">
                <p>
                    Current Balance: {{balance}}
                </p>
            </div>



            <div class="box">
                <p>
                    Spent Today: {{spent}}
                </p>
            </div>



            <div class="box">
                <p>
                    Earned Today: {{earned}}
                </p>
            </div>



            <div class="box">
                <p>
                    Difference: {{difference}}
                </p>
            </div>

            {{!-- <div class="tabs is-centered is-boxed">
                <ul>
                    <li class="is-active">
                        <a>
                            <span class="icon is-small"><i class="fa fa-image"></i></span>
                            <span>THIS DAY</span>
                        </a>
                    </li>
                    <li>
                        <a>
                            <span class="icon is-small"><i class="fa fa-music"></i></span>
                            <span>THIS WEEK</span>
                        </a>
                    </li>
                    <li>
                        <a>
                            <span class="icon is-small"><i class="fa fa-film"></i></span>
                            <span>THIS MONTH</span>
                        </a>
                    </li>
                    <li>
                        <a>
                            <span class="icon is-small"><i class="fa fa-file-alt"></i></span>
                            <span>THIS QUARTER</span>
                        </a>
                    </li>
                </ul>
            </div>

            <nav class="level">
                <div class="level-item has-text-centered">
                    <div>
                        <p class="heading">BALANCE</p>
                        <p class="title">1,000</p>
                    </div>
                </div>
                <div class="level-item has-text-centered">
                    <div>
                        <p class="heading">INCOMING</p>
                        <p class="title" style="color: green;">+2,000</p>
                    </div>
                </div>
                <div class="level-item has-text-centered">
                    <div>
                        <p class="heading">OUTGOING</p>
                        <p class="title" style="color: red;">-1,000</p>
                    </div>
                </div>
                <div class="level-item has-text-centered">
                    <div>
                        <p class="heading">DELTA</p>
                        <p class="title">+1,000</p>
                    </div>
                </div>
            </nav>

            <table class="table">
                <thead>
                    <tr>
                        <th>
                            <abbr title="date"> Date </abbr>
                        </th>
                        <th>
                            <abbr title="amount"> Amount </abbr>
                        </th>
                        <th>
                            <abbr title="company"> Company </abbr>
                        </th>
                        <th>
                            <abbr title="category"> Category </abbr>
                        </th>
                        <th>
                            <abbr title="notes"> Notes </abbr>
                        </th>
                    </tr>
                </thead>
                <tfoot>
                    <tr>
                        <th>
                            <abbr title="date"> Date </abbr>
                        </th>
                        <th>
                            <abbr title="amount"> Amount </abbr>
                        </th>
                        <th>
                            <abbr title="company"> Company </abbr>
                        </th>
                        <th>
                            <abbr title="category"> Category </abbr>
                        </th>
                        <th>
                            <abbr title="notes"> Notes </abbr>
                        </th>
                    </tr>
                </tfoot>
                <tbody>
                    <tr>
                        <th> 05/15 </th>
                        <td> 2000 </td>
                        <td> work </td>
                        <td> income </td>
                        <td>
                            <a href="https://en.wikipedia.org/wiki/Leicester_City_F.C." title="Leicester City F.C.">
                                Leicester City </a> <strong> (C) </strong> </td>
                    </tr>
                    <tr>
                        <th> 05/15 </th>
                        <td> 1000 </td>
                        <td> Taco Shop </td>
                        <td> food </td>
                        <td>a bunch of notes
                            <a href="https://en.wikipedia.org/wiki/Leicester_City_F.C." title="Leicester City F.C.">
                                Leicester City </a> <strong> (C) </strong> </td>
                    </tr>
                    <tr>
                        <th> 05/15 </th>
                        <td> 500 </td>
                        <td> freelance </td>
                        <td> income </td>
                        <td>
                            <a href="https://en.wikipedia.org/wiki/Leicester_City_F.C." title="Leicester City F.C.">
                                Leicester City </a> <strong> (C) </strong> </td>
                    </tr>
                    <tr>
                        <th> 05/15 </th>
                        <td> 500 </td>
                        <td> work </td>
                        <td> income </td>
                        <td>
                            <a href="https://en.wikipedia.org/wiki/Leicester_City_F.C." title="Leicester City F.C.">
                                Leicester City </a> <strong> (C) </strong> </td>
                    </tr>
                    <tr>
                        <th> 05/15 </th>
                        <td> 2000 </td>
                        <td> work </td>
                        <td> income </td>
                        <td>
                            <a href="https://en.wikipedia.org/wiki/Leicester_City_F.C." title="Leicester City F.C.">
                                Leicester City </a> <strong> (C) </strong> </td>
                    </tr>
                    <tr>
                        <th> 05/15 </th>
                        <td> 2000 </td>
                        <td> work </td>
                        <td> income </td>
                        <td>
                            <a href="https://en.wikipedia.org/wiki/Leicester_City_F.C." title="Leicester City F.C.">
                                Leicester City </a> <strong> (C) </strong> </td>
                    </tr>
                    <tr>
                        <th> 05/15 </th>
                        <td> 2000 </td>
                        <td> work </td>
                        <td> income </td>
                        <td>
                            <a href="https://en.wikipedia.org/wiki/Leicester_City_F.C." title="Leicester City F.C.">
                                Leicester City </a> <strong> (C) </strong> </td>
                    </tr>
                </tbody>
            </table>
 --}}


            <div class="buttons">
                <button id="expense" class="button is-dark"><a href="/coordinates">Add Coordinate</a></button>
                <!-- <button id="income" class="button is-dark">Add Income</button> -->
            </div>

        </div>



        <br>
        <div class="column">
            <div class="title" style="text-align: center;">Your CashMap for the Day</div>
            <div><canvas id="myChart" width="100px" height="100px"></canvas></div>

        </div>


    </div>
</div>





<script>
    $(document).ready(function () {
        // Getting references to our form and inputs
        const postForm = $("form.forum-post");
        const titleInput = $("input#title-input");
        const bodyInput = $("textarea#body-input");
        let timeData = 0;
        let dataArray = [0];
        let userEmail = $(".email-user").text().substring(7,($(".email-user").text().length -1));
        let currentUserId = "";
        let maxGraphBounds = 0;

        // When the form is submitted, we validate there's a title and body entered
        postForm.on("submit", function (event) {
            event.preventDefault();
            console.log(bodyInput.val(), titleInput.val())
            var postData = {
                title: titleInput.val().trim(),
                body: bodyInput.val().trim()
            };

            if (!postData.title || !postData.body) {
                return;
            }


            // If we have a title and password  we run the sendPost function and clear the form
            sendPost(postData.title, postData.body);
            titleInput.val("");
            bodyInput.val("");
        });

        // sendPost does a post to our "api/posts" route and if successful, redirects us the the forum page
        function sendPost(title, body) {
            $.post("/api/posts", {
                title: title,
                body: body
            })
                .then(function () {
                    window.location.replace("/forum");
                    // If there's an error, log the error
                })
                .catch(function (err) {
                    console.log(err);
                });
        }

        function getUser(){
            $.get("/api/users", function(data){
                console.log(data);
                for(let i = 0; i < data.length; i++ ){
                    if( data[i].email === userEmail){
                        currentUserId = data[i].id;
                    }
                }
                
            })
        }

        function getPost() {
            $.get("/api/coordinates", function (data) {
                if (timeData === 0) {
                    todaysData(data);
                }
            })
        }
        getUser();
        getPost();
        console.log("dataArray", dataArray);
        console.log(userEmail);

        
        //Creates a data array of balance changes for the current date
        function todaysData(data) {
            for (let i = 0; i < data.length; i++) {


                if (data[i].createdAt.substring(0, 10) != moment().utcOffset(5).format("YYYY-MM-DD") && data[i].UserId == currentUserId) {
                    
                    console.log(data[i]);
                    dataArray[0] += (data[i].amount);
                }
                else if (data[i].createdAt.substring(0, 10) === moment().utcOffset(5).format("YYYY-MM-DD") && data[i].UserId == currentUserId) {
                    console.log(data[i].amount)
                    dataArray.push(data[i].amount + dataArray[dataArray.length - 1]);
                };

            }
            console.log(dataArray);
            if(dataArray.length > 10){
                dataArray = dataArray.slice((dataArray.length - 10) , (dataArray.length))
            }
            maxGraphBounds = dataArray.reduce((a,b) => Math.max(a,b));
            console.log(dataArray);
            console.log(maxGraphBounds);
            displayChart();
        }

        function displayChart() {
            var ctx = document.getElementById('myChart').getContext('2d');
            var myChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10],
                    datasets: [{
                        data: dataArray,
                        label: "Balance",
                        borderColor: "#3e95cd",
                        fill: false,
                        showLines: true
                    }
                    ]
                },
                options: {

                    title: {
                        display: true,
                        text: 'Coordinates'
                    },
                    scales: {
                        yAxes: [{
                            responsive: true,
                            display: true,
                            scaleLabel: {
                                display: true,
                                labelString: "$"
                            },
                            ticks: {
                                max: (maxGraphBounds + 500),
                                min: -(maxGraphBounds + 500),
                                stepSize: 250,
                                beginAtZero: true
                            }
                        }]
                    }
                }
            });
        }
    });
</script>